<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Biblioteca Valdineia</title>
  <style>
    /* ====== Estilos Gerais ====== */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #671468;
      color: white;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    header {
      background: #2a42ff;
      color: #fff;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    h1 {
      margin: 0;
    }

    .btn {
      background: #6a1b9a;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease, color 0.3s ease;
      font-weight: 600;
    }

    .btn:hover {
      background: #8e24aa;
    }

    .btn-danger {
      background: #c62828;
    }

    .btn-danger:hover {
      background: #e53935;
    }

    .menu {
      display: flex;
      gap: 20px;
      padding: 20px;
      flex-wrap: wrap;
    }

    .card {
      background: #0084d0;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      cursor: pointer;
      flex: 1;
      /*min-width: 180px;*/
      text-align: center;
      transition: 0.2s;
    }

    .card:hover {
      transform: translateY(-3px);
    }

    .section {
      padding: 20px;
    }

    .hidden {
      display: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-top: 10px;
      color: #000;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    thead {
      background: #2a42ff;
      color: white;
    }

    th, td {
      font-weight: bold;
      padding: 8px;
      border: 1.5px solid #000000;
    }

    .table-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .toast {
      position: fixed;
      bottom: 15px;
      right: 15px;
      background: #323232;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      display: none;
      z-index: 2000;
    }

    .form-centered {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    input, select {
      padding: 10px 15px;
      border-radius: 20px;
      border: 1.6px solid #000000;
      outline: none;
      width: 250px;
      text-align: center;
      font-size: 16px;
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    .input-centered {
      display: block;
      margin: 0 auto;
      padding: 10px 15px;
      border-radius: 20px;
      border: 1.2px solid #000000;
      width: 250px;
      text-align: center;
      font-size: 16px;
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(8px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1500;
    }

    .modal-content {
      background: linear-gradient(to bottom right, #1e1f6eab, #4f036eba);
      padding: 30px 40px;
      border-radius: 15px;
      box-shadow: 0 0 15px rgb(0, 0, 0);
      width: 320px;
      max-width: 90%;
      text-align: center;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .modal-content h2 {
      margin-bottom: 20px;
      color: white;
    }

    .modal-content input {
      width: 100%;
      padding: 12px 15px;
      margin-bottom: 15px;
      border-radius: 20px;
      border: 1.5px solid #666;
      outline: none;
      text-align: center;
      font-size: 16px;
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    .modal-content input:focus {
      border-color: #6a1b9a;
    }

    .modal-content .btn {
      width: 100%;
      padding: 12px;
      border-radius: 20px;
      font-size: 18px;
      background: #6a1b9a;
      border: none;
      color: white;
      cursor: pointer;
      transition: background 0.3s ease;
      font-weight: 600;
    }

    .modal-content .btn:hover {
      background: #8e24aa;
    }

    .modal.hidden {
      display: none;
    }

    body.modal-open main,
    body.modal-open header {
      filter: blur(6px);
      pointer-events: none;
      user-select: none;
    }

    #loginForm {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    #emailLogin {
      width: 250px;
      padding: 12px 15px;
      border-radius: 20px;
      border: 1.5px solid #666;
      text-align: left;
      font-size: 16px;
      outline: none;
    }

    .senha-container {
      position: relative;
      width: 250px;
    }

    .senha-container input {
      width: 100%;
      padding: 12px 90px 12px 15px;
      border-radius: 20px;
      border: 1.5px solid #666;
      font-size: 16px;
      text-align: left;
      outline: none;
      box-sizing: border-box;
    }

    .eye-btn {
      position: static;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 14px;
      color: white;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 12px;
      user-select: none;
      transition: background-color 0.2s ease;
    }

    .eye-btn:hover {
      background-color: #8e24aa;
      color: white;
    }

    /* ====== Tema Escuro ====== */
    body.dark-theme {
      background: #121212;
      color: #e0e0e0;
    }

    body.dark-theme header {
      background: #1f1f1f;
      color: #e0e0e0;
    }

    body.dark-theme .btn {
      background: #bb86fc;
      color: #121212;
    }

    body.dark-theme .btn:hover {
      background: #985eff;
      color: white;
    }

    body.dark-theme .menu .card {
      background: #222;
      color: #e0e0e0;
      box-shadow: 0 2px 6px rgba(255,255,255,0.05);
    }

    body.dark-theme .menu .card:hover {
      background: #333;
    }

    body.dark-theme table {
      background: #222;
      color: #e0e0e0;
      border-color: #444;
    }

    body.dark-theme table thead {
      background: #333;
      color: #e0e0e0;
    }

    body.dark-theme th, body.dark-theme td {
      border-color: #444;
    }

    body.dark-theme input,
    body.dark-theme select {
      background: #222;
      color: #e0e0e0;
      border-color: #444;
    }

    body.dark-theme .modal-content {
      background: #222;
      color: #e0e0e0;
      box-shadow: 0 0 15px rgba(255,255,255,0.2);
    }

    #themeToggleBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 4000; /* acima da modal */
      background: #6a1b9a;
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 30px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 4px 8px rgba(0,0,0,0.25);
      transition: background 0.3s ease, color 0.3s ease;
    }

    #themeToggleBtn:hover { background: #8e24aa; }

    dialog#dialogAddLivro {
      border: none;
      border-radius: 16px;
      width: min(680px, 92vw);
      padding: 18px 18px 8px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }

    dialog::backdrop {
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(2px);
    }

    .dialog-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .dialog-title {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }

    .dialog-search {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    #pesquisaLivro {
      flex: 1;
      width: auto;
      min-width: 220px;
      border-radius: 12px;
      text-align: left;
    }

    #selectMoverStatus {
      width: auto;
      min-width: 180px;
      border-radius: 12px;
    }

    .dialog-lista {
      max-height: 50vh;
      overflow: auto;
      margin: 0;
      padding: 0;
      list-style: none;
      border: 1px solid #ddd;
      border-radius: 12px;
    }

    .dialog-item {
      padding: 10px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid #eee;
    }

    .dialog-item:last-child { border-bottom: none; }

    .dialog-item-title {
      font-weight: 600;
    }

    .dialog-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 10px 0 2px;
    }

    /* Dark theme for dialog */
    body.dark-theme dialog#dialogAddLivro {
      background: #1f1f1f;
      color: #e0e0e0;
      box-shadow: 0 10px 30px rgba(255,255,255,0.08);
    }
    body.dark-theme .dialog-lista { border-color: #444; }
    body.dark-theme .dialog-item { border-bottom-color: #333; }
    body.dark-theme #pesquisaLivro,
    body.dark-theme #selectMoverStatus {
      background: #222; color: #e0e0e0; border-color: #444;
    }

    .menu .card {
  background: #0084d0; /* azul normal */
  color: white;
  padding: 20px;
  border-radius: 8px;
  cursor: pointer;
  text-align: center;
  transition: background 0.2s ease;
}

/* Hover */
.menu .card:hover {
  background: #00509e; /* azul escuro */
}

/* Selecionado */
.menu .card.selected {
  background: #006400; /* verde escuro */
}

  </style>
</head>

<button id="themeToggleBtn" class="btn">Tema Escuro</button>

<body>
  <header>
    <h1>📚 Biblioteca Valdineia</h1>
    <div class="header-actions" style="display: flex; align-items: center; gap: 10px;">
      <span id="usuarioLogado" style="color: white; margin-right: 15px;"></span>
      <button id="logoutBtn" class="btn">Sair</button>
    </div>
  </header>

  <!-- Modal Login -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <h2>Login</h2>
      <form id="loginForm">
        <input type="email" id="emailLogin" placeholder="Email" required />
        <div class="senha-container">
          <input type="password" id="senhaLogin" placeholder="Senha" required />
          <button type="button" id="toggleSenha" aria-label="Mostrar senha" class="eye-btn">Mostrar Senha</button>
        </div>
        <button type="submit" class="btn">Entrar</button>
      </form>
    </div>
  </div>

  <main>
    <section id="menuSection" class="menu">
      <div class="card" data-section="cadastrarLivro">➕ Cadastrar Livro</div>
      <div class="card" data-section="verLivros">📋 Ver Livros</div>
      <div class="card" data-status="Estou Lendo">📖 Estou Lendo</div>
      <div class="card" data-status="Quero Ler">📅 Quero Ler</div>
      <div class="card" data-status="Lidos">✅ Lidos</div>
      <div class="card" data-status="Parei de Ler">⏸️ Parei de Ler</div>
      <div class="card" data-section="removerLivro">🗑️ Remover Livro</div>
    </section>

    <!-- Cadastro -->
    <section id="cadastrarLivro" class="section hidden">
      <h2>Cadastrar Livro</h2>
      <form id="cadastroLivroForm" class="form-centered">
        <input type="text" id="nomeLivro" placeholder="Nome do Livro" required />
        <input type="text" id="autorLivro" placeholder="Autor" required />
        <input type="text" id="prateleiraLivro" placeholder="Número da Prateleira" required />
        <input type="month" id="mesAnoLivro" placeholder="Mês/Ano" required />
        <button type="button" id="btnAbrirPicker" class="btn">📅 Selecionar Mês</button>

        <button type="submit" class="btn">Cadastrar</button>
      </form>
    </section>

    <!-- Lista de Livros -->
    <section id="verLivros" class="section hidden">
      <h2>Livros Cadastrados</h2>
      <input type="text" id="filtroLivros" placeholder="Filtrar..." class="input-centered" />
      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>Autor</th>
            <th>Prateleira</th>
            <th>Mês/Ano</th>
          </tr>
        </thead>
        <tbody id="livrosCadastrados"></tbody>
      </table>
    </section>

    <!-- Status -->
    <section id="statusSection" class="section hidden">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap: wrap;">
        <h2 id="statusTitulo" style="margin:0;"></h2>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="btnAddLivro" class="btn">➕ Adicionar Livro</button>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>Autor</th>
            <th>Prateleira</th>
            <th>Mês/Ano</th>
            <th style="width:360px;">Ação</th>
          </tr>
        </thead>
        <tbody id="statusLivrosTabela"></tbody>
      </table>
    </section>

    <!-- Remoção -->
    <section id="removerLivro" class="section hidden">
      <h2>Remover Livro</h2>
      <input type="text" id="filtroRemover" placeholder="Filtrar..." class="input-centered" />
      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>Autor</th>
            <th>Prateleira</th>
            <th>Mês/Ano</th>
            <th>Ação</th>
          </tr>
        </thead>
        <tbody id="listaRemover"></tbody>
      </table>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <dialog id="dialogAddLivro">
    <div class="dialog-header">
      <h3 class="dialog-title">Selecionar Livro</h3>
      <button id="btnFecharDialog" class="btn btn-danger">Fechar</button>
    </div>

    <div class="dialog-search">
      <input type="text" id="pesquisaLivro" placeholder="Pesquisar livro por nome ou autor..." />
      <select id="selectMoverStatus" title="Mover status (opcional)">
        <option value="">Adicionar como: (status atual)</option>
        <option value="Estou Lendo">Estou Lendo</option>
        <option value="Quero Ler">Quero Ler</option>
        <option value="Lidos">Lidos</option>
        <option value="Parei de Ler">Parei de Ler</option>
      </select>
      <span id="labelStatusAtual" style="font-size:14px;opacity:.8;"></span>
    </div>

    <ul id="listaLivros" class="dialog-lista"></ul>

    <div class="dialog-footer">
      <button id="btnFecharDialog2" class="btn btn-danger">Fechar</button>
    </div>
  </dialog>

  <dialog id="confirmDialog">
  <div style="padding:20px; max-width:400px; text-align:center;">
    <p id="confirmMessage" style="margin-bottom:20px;"></p>
    <div style="display:flex; justify-content:center; gap:10px;">
      <button id="confirmYes" class="btn btn-success">Sim</button>
      <button id="confirmNo" class="btn btn-danger">Não</button>
    </div>
  </div>
</dialog>


<script type="module">
import { auth, db } from './firebase-config.js';
import { signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
import { collection, getDocs, addDoc, deleteDoc, doc, query, where, setDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

const sections = document.querySelectorAll('.section');
const menuCards = document.querySelectorAll('.card');
const toast = document.getElementById('toast');

const loginModal = document.getElementById('loginModal');
const loginForm = document.getElementById('loginForm');
const logoutBtn = document.getElementById('logoutBtn');
const usuarioLogadoSpan = document.getElementById('usuarioLogado');

const senhaInput = document.getElementById('senhaLogin');
const toggleSenhaBtn = document.getElementById('toggleSenha');

const themeToggleBtn = document.getElementById('themeToggleBtn');

// Modos: 'numeric' ou 'alphanumeric'
const PRATELEIRA_MODE = 'numeric';

function sanitizePrateleira(value) {
  if (PRATELEIRA_MODE === 'numeric') {
    return value.replace(/\D+/g, '');
  }
  return value.toUpperCase().replace(/[^A-Z0-9-]/g, '');
}

function validatePrateleira(value) {
  if (PRATELEIRA_MODE === 'numeric') return /^\d+$/.test(value);
  return /^[A-Z0-9-]+$/.test(value);
}

function toFirestorePrateleira(value) {
  return PRATELEIRA_MODE === 'numeric' ? Number(value) : value;
}

const prateleiraInput = document.getElementById('prateleiraLivro');
prateleiraInput.addEventListener('input', () => {
  prateleiraInput.value = sanitizePrateleira(prateleiraInput.value);
});

let statusAtual = "";
let todosLivros = [];
let mapaStatusPorLivro = {};
const STATUS_OPCOES = ["Estou Lendo", "Quero Ler", "Lidos", "Parei de Ler"];

// ====== Toast helper ======
function showToast(msg) {
  toast.textContent = msg;
  toast.style.display = 'block';
  setTimeout(() => toast.style.display = 'none', 3000);
}

// ====== Formata data MM/YYYY ======
function formatMesAnoBR(valor) {
  if (!valor) return '';
  const [ano, mes] = valor.split('-');
  return `${mes}/${ano}`;
}

// ====== Modal Login ======
function showLoginModal() {
  loginModal.classList.remove('hidden');
  document.body.classList.add('modal-open');
}
function hideLoginModal() {
  loginModal.classList.add('hidden');
  document.body.classList.remove('modal-open');
}

onAuthStateChanged(auth, async user => {
  if (user) {
    usuarioLogadoSpan.textContent = user.email;
    hideLoginModal();
    await carregarTodosLivros();
    await carregarLivros();
  } else {
    usuarioLogadoSpan.textContent = '';
    showLoginModal();
    sections.forEach(sec => sec.classList.add('hidden'));
  }
});

loginForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = document.getElementById('emailLogin').value.trim();
  const senha = senhaInput.value.trim();
  if (!email || !senha) { showToast('Preencha email e senha.'); return; }

  try {
    await signInWithEmailAndPassword(auth, email, senha);
    showToast('Logado com sucesso!');
    loginForm.reset();
  } catch (error) {
    showToast('Erro no login: ' + error.message);
  }
});

toggleSenhaBtn.addEventListener('click', () => {
  const tipo = senhaInput.type === 'password' ? 'text' : 'password';
  senhaInput.type = tipo;
  toggleSenhaBtn.textContent = tipo === 'password' ? 'Mostrar Senha' : 'Ocultar Senha';
});

logoutBtn.addEventListener('click', async () => {
  await signOut(auth);
  showToast('Deslogado!');
  sections.forEach(sec => sec.classList.add('hidden'));
});

// ====== Navegação do menu ======
menuCards.forEach(card => {
  card.addEventListener('click', async () => {
    // Remove a seleção de todos os cards
    menuCards.forEach(c => c.classList.remove('selected'));

    // Adiciona a seleção ao card clicado
    card.classList.add('selected');

    const sectionId = card.dataset.section;
    const status = card.dataset.status;

    sections.forEach(sec => sec.classList.add('hidden'));

    if (sectionId) {
      document.getElementById(sectionId).classList.remove('hidden');
      if (sectionId === 'verLivros') await carregarLivros();
      else if (sectionId === 'removerLivro') await carregarLivrosParaRemover();
    } else if (status) {
      statusAtual = status;
      document.getElementById('statusTitulo').textContent = statusAtual;
      document.getElementById('labelStatusAtual').textContent = `Status atual: ${statusAtual}`;
      await carregarMapaStatusDoUsuario();
      await carregarLivrosPorStatus(statusAtual);
      document.getElementById('statusSection').classList.remove('hidden');
    }
  });
});


async function carregarTodosLivros() {
  const snap = await getDocs(collection(db, 'livros'));
  todosLivros = snap.docs.map(d => {
    const data = d.data();
    let prateleira = data.prateleira;
    if (typeof prateleira === 'string' && /^\d+$/.test(prateleira)) prateleira = Number(prateleira);
    return { id: d.id, ...data, prateleira };
  });
  todosLivros.sort((a, b) => a.nome.localeCompare(b.nome, 'pt', { sensitivity: 'base' }));
}

async function carregarLivros() {
  try {
    if (todosLivros.length === 0) await carregarTodosLivros();
    renderTabela(todosLivros, 'livrosCadastrados', false);
    sections.forEach(sec => sec.classList.add('hidden'));
    document.getElementById('verLivros').classList.remove('hidden');
  } catch (error) {
    showToast('Erro ao carregar livros: ' + error.message);
  }
}

async function carregarLivrosParaRemover() {
  try {
    if (todosLivros.length === 0) await carregarTodosLivros();
    renderTabela(todosLivros, 'listaRemover', true);
  } catch (error) {
    showToast('Erro ao carregar livros para remover: ' + error.message);
  }
}

function renderTabela(livros, idTabela, comAcoes) {
  const tbody = document.getElementById(idTabela);
  tbody.innerHTML = '';
  livros.forEach(livro => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${livro.nome}</td>
      <td>${livro.autor}</td>
      <td>${livro.prateleira || ''}</td>
      <td>${formatMesAnoBR(livro.mesAno) || ''}</td>
      ${comAcoes ? `<td><button class="btn btn-danger" data-id="${livro.id}">Remover</button></td>` : ''}
    `;
    tbody.appendChild(tr);
  });

  if (comAcoes) {
    tbody.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', async () => {
        const ok = await showConfirm('Tem certeza que deseja remover este livro?');
        if (!ok) return;

        try {
          const livroId = btn.dataset.id;
          await deleteDoc(doc(db, 'livros', livroId));
          const qStatus = query(collection(db, 'statusLivros'), where('livroId', '==', livroId));
          const snapStatus = await getDocs(qStatus);
          const deletions = snapStatus.docs.map(d => deleteDoc(doc(db, 'statusLivros', d.id)));
          await Promise.all(deletions);

          showToast('Livro e seus status removidos!');
          await carregarTodosLivros();
          await carregarLivros();
        } catch (error) {
          showToast('Erro ao remover: ' + error.message);
        }
      });
    });
  }
}

document.getElementById('cadastroLivroForm').addEventListener('submit', async e => {
  e.preventDefault();
  const nome = document.getElementById('nomeLivro').value.trim();
  const autor = document.getElementById('autorLivro').value.trim();
  const prateleiraRaw = document.getElementById('prateleiraLivro').value.trim();
  const prateleiraSan = sanitizePrateleira(prateleiraRaw);
  const mesAno = document.getElementById('mesAnoLivro').value.trim();

  if (!nome || !autor || !prateleiraSan || !mesAno) { showToast('Preencha todos os campos.'); return; }
  if (!validatePrateleira(prateleiraSan)) {
    showToast(PRATELEIRA_MODE==='numeric' ? 'A prateleira deve conter apenas números.' : 'A prateleira deve conter apenas letras, números ou hífen.');
    return;
  }

  try {
    const qLivros = query(collection(db,'livros'), where('nome','==',nome), where('autor','==',autor));
    const snapshot = await getDocs(qLivros);
    if (!snapshot.empty) { showToast('Livro já cadastrado.'); return; }

    await addDoc(collection(db, 'livros'), { nome, autor, prateleira: toFirestorePrateleira(prateleiraSan), mesAno });
    showToast('Livro cadastrado!');
    e.target.reset();
    await carregarTodosLivros();
    await carregarLivros();
  } catch (error) {
    showToast('Erro ao cadastrar: ' + error.message);
  }
});

const mesAnoInput = document.getElementById('mesAnoLivro');
const btnAbrirPicker = document.getElementById('btnAbrirPicker');

btnAbrirPicker.addEventListener('click', () => {
  if (mesAnoInput.showPicker) mesAnoInput.showPicker();
  else mesAnoInput.focus();
});

document.getElementById('filtroLivros').addEventListener('input', e => filtrarTabela('livrosCadastrados', e.target.value));
document.getElementById('filtroRemover').addEventListener('input', e => filtrarTabela('listaRemover', e.target.value));

function filtrarTabela(idTabela, filtro) {
  const rows = document.getElementById(idTabela).querySelectorAll('tr');
  rows.forEach(row => { row.style.display = row.textContent.toLowerCase().includes(filtro.toLowerCase()) ? '' : 'none'; });
}

async function carregarMapaStatusDoUsuario() {
  mapaStatusPorLivro = {};
  const user = auth.currentUser;
  if (!user) return;

  const qUser = query(collection(db, 'statusLivros'), where('usuarioId','==',user.uid));
  const snap = await getDocs(qUser);
  snap.forEach(d => { const data = d.data(); mapaStatusPorLivro[data.livroId] = { status:data.status,_docId:d.id }; });
}

async function carregarLivrosPorStatus(status) {
  const user = auth.currentUser;
  if (!user) return;

  if (!Object.keys(mapaStatusPorLivro).length) await carregarMapaStatusDoUsuario();
  const livrosFiltrados = todosLivros.filter(l => mapaStatusPorLivro[l.id]?.status === status);
  renderTabelaStatus(livrosFiltrados, status);
}

function renderTabelaStatus(livros, status) {
  const tbody = document.getElementById('statusLivrosTabela');
  tbody.innerHTML = '';

  livros.forEach(livro => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${livro.nome}</td>
      <td>${livro.autor}</td>
      <td>${livro.prateleira ?? ''}</td>
      <td>${formatMesAnoBR(livro.mesAno) || ''}</td>
      <td>
        <div class="table-actions">
          <select class="selectMover" data-livro="${livro.id}">
            <option value="">Mover para...</option>
            ${STATUS_OPCOES.map(s => `<option value="${s}" ${s===status?'disabled':''}>${s}</option>`).join('')}
          </select>
          <button class="btn btn-danger btnRemoverStatus" data-livro="${livro.id}">Remover da lista</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll('.selectMover').forEach(sel => {
    sel.addEventListener('change', async () => {
      const novoStatus = sel.value;
      if (!novoStatus) return;
      await upsertStatus(sel.dataset.livro, novoStatus);
      await carregarMapaStatusDoUsuario();
      await carregarLivrosPorStatus(statusAtual);
      showToast('Status atualizado!');
    });
  });

  tbody.querySelectorAll('.btnRemoverStatus').forEach(btn => {
    btn.addEventListener('click', async () => {
      const ok = await showConfirm('Remover este livro desta lista?');
      if (!ok) return;
      await removerStatus(btn.dataset.livro);
      await carregarMapaStatusDoUsuario();
      await carregarLivrosPorStatus(statusAtual);
      showToast('Livro removido da lista.');
    });
  });
}

async function upsertStatus(livroId, novoStatus) {
  const user = auth.currentUser;
  if (!user) return;

  const q = query(collection(db,'statusLivros'), where('usuarioId','==',user.uid), where('livroId','==',livroId));
  const snap = await getDocs(q);

  if (!snap.empty) {
    const docRef = doc(db,'statusLivros',snap.docs[0].id);
    await setDoc(docRef, { usuarioId:user.uid, livroId, status:novoStatus });
  } else {
    const docId = `${user.uid}_${livroId}`;
    const docRef = doc(db,'statusLivros',docId);
    await setDoc(docRef, { usuarioId:user.uid, livroId, status:novoStatus });
  }
}

async function removerStatus(livroId) {
  const user = auth.currentUser;
  if (!user) return;

  const docId = `${user.uid}_${livroId}`;
  await deleteDoc(doc(db,'statusLivros',docId)).catch(async ()=>{
    const q = query(collection(db,'statusLivros'), where('usuarioId','==',user.uid), where('livroId','==',livroId));
    const snap = await getDocs(q);
    const deletions = snap.docs.map(d=>deleteDoc(doc(db,'statusLivros',d.id)));
    await Promise.all(deletions);
  });
}

const dialog = document.getElementById('dialogAddLivro');
const lista = document.getElementById('listaLivros');
const pesquisa = document.getElementById('pesquisaLivro');
const selectMoverStatus = document.getElementById('selectMoverStatus');
const labelStatusAtual = document.getElementById('labelStatusAtual');

function abrirDialogLivros() {
  selectMoverStatus.value = '';
  labelStatusAtual.textContent = `Status atual: ${statusAtual}`;
  pesquisa.value = '';
  renderListaDialog('');
  dialog.showModal();
}

function renderListaDialog(filtro) {
  lista.innerHTML = '';

  const filtrados = todosLivros
    .filter(l => l.nome.toLowerCase().includes(filtro.toLowerCase()) || (l.autor||'').toLowerCase().includes(filtro.toLowerCase()))
    .sort((a,b)=>a.nome.localeCompare(b.nome,'pt',{sensitivity:'base'}));

  filtrados.forEach(livro => {
    const li = document.createElement('li');
    li.className = 'dialog-item';

    const statusExistente = mapaStatusPorLivro[livro.id]?.status || '';

    li.innerHTML = `
      <div>
        <div class="dialog-item-title">${livro.nome}</div>
        <div style="font-size:13px; opacity:.8;">
          ${livro.autor||''} 
          ${livro.prateleira!=null ? '• Prateleira ' + livro.prateleira : ''}  
          ${livro.mesAno ? '• ' + formatMesAnoBR(livro.mesAno) : ''}
        </div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        ${statusExistente ? `<span style="font-size:12px; padding:4px 8px; border-radius:12px; border:1px solid #bbb;">${statusExistente}</span>` : ''}
        <button class="btn btnAddAoStatus" data-livro="${livro.id}">Adicionar</button>
      </div>
    `;
    lista.appendChild(li);
  });

  lista.querySelectorAll('.btnAddAoStatus').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const livroId = btn.dataset.livro;
      const destino = selectMoverStatus.value || statusAtual;
      await upsertStatus(livroId,destino);
      await carregarMapaStatusDoUsuario();
      await carregarLivrosPorStatus(statusAtual);
      showToast(`Livro definido como "${destino}".`);
      renderListaDialog(pesquisa.value);
    });
  });
}

document.getElementById('btnAddLivro').addEventListener('click', async ()=>{ await carregarMapaStatusDoUsuario(); abrirDialogLivros(); });
document.getElementById('btnFecharDialog').addEventListener('click', ()=>dialog.close());
document.getElementById('btnFecharDialog2').addEventListener('click', ()=>dialog.close());
pesquisa.addEventListener('input', ()=>renderListaDialog(pesquisa.value));
selectMoverStatus.addEventListener('change', ()=>{
  const dest = selectMoverStatus.value || statusAtual;
  labelStatusAtual.textContent = `Adicionar como: ${dest}`;
});

function applyTheme(theme) {
  if(theme==='dark'){document.body.classList.add('dark-theme'); themeToggleBtn.textContent='Tema Claro';}
  else {document.body.classList.remove('dark-theme'); themeToggleBtn.textContent='Tema Escuro';}
  localStorage.setItem('theme', theme);
}
const savedTheme = localStorage.getItem('theme') || 'light';
applyTheme(savedTheme);
themeToggleBtn.addEventListener('click', ()=>{
  const currentTheme = document.body.classList.contains('dark-theme')?'dark':'light';
  const newTheme = currentTheme==='dark'?'light':'dark';
  applyTheme(newTheme);
});

function showConfirm(message) {
  return new Promise(resolve=>{
    const dialog = document.getElementById('confirmDialog');
    const msg = document.getElementById('confirmMessage');
    const yesBtn = document.getElementById('confirmYes');
    const noBtn = document.getElementById('confirmNo');

    msg.textContent = message;

    function cleanup(){ yesBtn.removeEventListener('click',onYes); noBtn.removeEventListener('click',onNo); dialog.close(); }
    function onYes(){ cleanup(); resolve(true); }
    function onNo(){ cleanup(); resolve(false); }

    yesBtn.addEventListener('click',onYes);
    noBtn.addEventListener('click',onNo);

    dialog.showModal();
  });
}

</script>

</body>
</html>
